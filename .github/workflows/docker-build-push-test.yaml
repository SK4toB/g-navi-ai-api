name: FastAPI Docker Build & Push (Optimized)

on:
    push:
        branches: [main, ci/k8s]
    pull_request:
        branches: [main]

env:
    IMAGE_REGISTRY: amdp-registry.skala-ai.com/skala25a
    BASE_IMAGE_NAME: sk-gnavi4-ai-base
    APP_IMAGE_NAME: sk-gnavi4-ai
    BASE_VERSION: '1.0.0' # ê³ ì • ë²„ì „ ì‚¬ìš©

jobs:
    # ê°„ì†Œí™”ëœ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤
    build-and-push:
        runs-on: ubuntu-latest
        timeout-minutes: 20
        steps:
            - name: Checkout source code
              uses: actions/checkout@v4

            - name: Set up Python 3.10
              uses: actions/setup-python@v4
              with:
                  python-version: '3.10'

            # ë¹ ë¥¸ ë¬¸ë²• ì²´í¬
            - name: Quick syntax validation
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  python -m py_compile app/main.py
              timeout-minutes: 3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            # Harbor ì—°ê²° í…ŒìŠ¤íŠ¸
            - name: Test Harbor connection
              run: |
                  echo "ğŸ” Harbor ì—°ê²° í…ŒìŠ¤íŠ¸..."
                  curl -sSf -m 10 https://amdp-registry.skala-ai.com/v2/ > /dev/null
                  echo "âœ… Harbor ì—°ê²° ì„±ê³µ"

            # Docker ë¡œê·¸ì¸
            - name: Log in to Harbor Registry
              run: |
                  echo "ğŸ” Harbor ë¡œê·¸ì¸ ì¤‘..."
                  echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ env.IMAGE_REGISTRY }} \
                    --username "${{ secrets.HARBOR_USERNAME }}" --password-stdin
                  echo "âœ… Harbor ë¡œê·¸ì¸ ì„±ê³µ"

            # ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
            - name: Check base image exists
              run: |
                  echo "ğŸ” ë² ì´ìŠ¤ ì´ë¯¸ì§€ í™•ì¸ ì¤‘..."
                  if docker manifest inspect ${{ env.IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ env.BASE_VERSION }} >/dev/null 2>&1; then
                    echo "âœ… ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì¡´ì¬: ${{ env.BASE_VERSION }}"
                  else
                    echo "âŒ ë² ì´ìŠ¤ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤!"
                    echo "::error::ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ë¹Œë“œí•˜ê³  í‘¸ì‹œí•´ì£¼ì„¸ìš”"
                    echo "ì‹¤í–‰: ./base-build.sh && ./base-push.sh"
                    exit 1
                  fi

            - name: Generate image tags
              id: generate_tag
              run: |
                  BUILD_NUMBER="${{ github.run_number }}"
                  HASH=$(date +%s%N | sha256sum | cut -c1-12)
                  FINAL_IMAGE_TAG="${BUILD_NUMBER}-${HASH}"

                  echo "FINAL_IMAGE_TAG=$FINAL_IMAGE_TAG" >> $GITHUB_ENV
                  echo "Final Tag: $FINAL_IMAGE_TAG"

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
            - name: Build and push application image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  platforms: linux/amd64
                  push: true
                  tags: |
                      ${{ env.IMAGE_REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ env.FINAL_IMAGE_TAG }}
                      ${{ env.IMAGE_REGISTRY }}/${{ env.APP_IMAGE_NAME }}:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      BUILDKIT_INLINE_CACHE=1
                      BASE_IMAGE_TAG=${{ env.BASE_VERSION }}
              timeout-minutes: 10

            - name: Build success
              run: |
                  echo "âœ… ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ!"
                  echo "ë² ì´ìŠ¤ ì´ë¯¸ì§€: ${{ env.IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ env.BASE_VERSION }}"
                  echo "ì•± ì´ë¯¸ì§€: ${{ env.IMAGE_REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ env.FINAL_IMAGE_TAG }}"
                  echo "Harborì—ì„œ í™•ì¸ë°”ëŒ"
