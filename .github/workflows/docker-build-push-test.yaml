name: FastAPI Docker Build & Push (Optimized)

on:
    push:
        branches: [main, ci/k8s]
    pull_request:
        branches: [main]

env:
    IMAGE_REGISTRY: amdp-registry.skala-ai.com/skala25a
    BASE_IMAGE_NAME: sk-gnavi4-ai-base
    APP_IMAGE_NAME: sk-gnavi4-ai
    DOCKER_CREDENTIAL_ID: skala-image-registry-id

jobs:
    # ë² ì´ìŠ¤ ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€ ë° ë¹Œë“œ
    check-base-changes:
        runs-on: ubuntu-latest
        outputs:
            base-changed: ${{ steps.changes.outputs.base }}
            requirements-hash: ${{ steps.hash.outputs.requirements-hash }}
        steps:
            - name: Checkout source code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Check for base image changes
              id: changes
              run: |
                  if git diff --name-only HEAD~1 HEAD | grep -E "(requirements\.txt|Dockerfile\.base)"; then
                    echo "base=true" >> $GITHUB_OUTPUT
                    echo "ğŸ”„ ë² ì´ìŠ¤ ì´ë¯¸ì§€ ê´€ë ¨ íŒŒì¼ ë³€ê²½ ê°ì§€"
                  else
                    echo "base=false" >> $GITHUB_OUTPUT
                    echo "âœ… ë² ì´ìŠ¤ ì´ë¯¸ì§€ ë³€ê²½ ì—†ìŒ"
                  fi

            - name: Generate requirements hash
              id: hash
              run: |
                  REQUIREMENTS_HASH=$(sha256sum requirements.txt | cut -d' ' -f1 | cut -c1-12)
                  echo "requirements-hash=$REQUIREMENTS_HASH" >> $GITHUB_OUTPUT
                  echo "Requirements Hash: $REQUIREMENTS_HASH"

    # ë² ì´ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ (requirements.txt ë³€ê²½ì‹œì—ë§Œ)
    build-base-image:
        runs-on: ubuntu-latest
        needs: check-base-changes
        if: needs.check-base-changes.outputs.base-changed == 'true'
        timeout-minutes: 20
        steps:
            - name: Checkout source code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.IMAGE_REGISTRY }}
                  username: ${{ secrets.HARBOR_USERNAME }}
                  password: ${{ secrets.HARBOR_PASSWORD }}

            - name: Check if base image exists
              id: check-base
              run: |
                  REQUIREMENTS_HASH="${{ needs.check-base-changes.outputs.requirements-hash }}"
                  if docker manifest inspect ${{ env.IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:$REQUIREMENTS_HASH >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "âœ… ë² ì´ìŠ¤ ì´ë¯¸ì§€ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "ğŸ”¨ ë² ì´ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤"
                  fi

            - name: Build and push base image
              if: steps.check-base.outputs.exists == 'false'
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile.base
                  platforms: linux/amd64
                  push: true
                  tags: |
                      ${{ env.IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ needs.check-base-changes.outputs.requirements-hash }}
                      ${{ env.IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:latest
                  cache-from: type=gha,scope=base
                  cache-to: type=gha,mode=max,scope=base
                  build-args: |
                      BUILDKIT_INLINE_CACHE=1

            - name: Base image build success
              run: |
                  echo "âœ… ë² ì´ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
                  echo "ì´ë¯¸ì§€: ${{ env.IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ needs.check-base-changes.outputs.requirements-hash }}"

    # ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
    build-and-push:
        runs-on: ubuntu-latest
        needs: [check-base-changes, build-base-image]
        if: always() && !failure()
        timeout-minutes: 15
        steps:
            - name: Checkout source code
              uses: actions/checkout@v4

            - name: Set up Python 3.10
              uses: actions/setup-python@v4
              with:
                  python-version: '3.10'

            # Python íŒ¨í‚¤ì§€ ìºì‹± (ë² ì´ìŠ¤ ì´ë¯¸ì§€ì— í¬í•¨ë˜ë¯€ë¡œ ë¹ ë¥¸ ê²€ì¦ìš©)
            - name: Cache Python packages
              uses: actions/cache@v3
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            # ë¹ ë¥¸ ë¬¸ë²• ì²´í¬ (ë² ì´ìŠ¤ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë¯€ë¡œ ê°„ì†Œí™”)
            - name: Quick syntax validation
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  python -m py_compile app/main.py
              timeout-minutes: 5

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.IMAGE_REGISTRY }}
                  username: ${{ secrets.HARBOR_USERNAME }}
                  password: ${{ secrets.HARBOR_PASSWORD }}

            - name: Generate image tags
              id: generate_tag
              run: |
                  BUILD_NUMBER="${{ github.run_number }}"
                  HASH=$(date +%s%N | sha256sum | cut -c1-12)
                  FINAL_IMAGE_TAG="${BUILD_NUMBER}-${HASH}"
                  REQUIREMENTS_HASH="${{ needs.check-base-changes.outputs.requirements-hash }}"

                  echo "FINAL_IMAGE_TAG=$FINAL_IMAGE_TAG" >> $GITHUB_ENV
                  echo "BASE_IMAGE_TAG=$REQUIREMENTS_HASH" >> $GITHUB_ENV
                  echo "Final Tag: $FINAL_IMAGE_TAG"
                  echo "Base Image Tag: $REQUIREMENTS_HASH"

            # ìµœì í™”ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
            - name: Build and push application image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  platforms: linux/amd64
                  push: true
                  tags: |
                      ${{ env.IMAGE_REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ env.FINAL_IMAGE_TAG }}
                      ${{ env.IMAGE_REGISTRY }}/${{ env.APP_IMAGE_NAME }}:latest
                  cache-from: type=gha,scope=app
                  cache-to: type=gha,mode=max,scope=app
                  build-args: |
                      BUILDKIT_INLINE_CACHE=1
                      BASE_IMAGE_TAG=${{ env.BASE_IMAGE_TAG }}
              timeout-minutes: 10

            - name: Application build success
              run: |
                  echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì„±ê³µ"
                  echo "ì´ë¯¸ì§€: ${{ env.IMAGE_REGISTRY }}/${{ env.APP_IMAGE_NAME }}:${{ env.FINAL_IMAGE_TAG }}"
                  echo "ë² ì´ìŠ¤ ì´ë¯¸ì§€: ${{ env.IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ env.BASE_IMAGE_TAG }}"
                  echo "Harborì—ì„œ í™•ì¸ë°”ëŒ"

    # ë¹Œë“œ ìš”ì•½ ë° ì„±ëŠ¥ ë¦¬í¬íŠ¸
    build-summary:
        runs-on: ubuntu-latest
        needs: [check-base-changes, build-base-image, build-and-push]
        if: always()
        steps:
            - name: Build Summary
              run: |
                  echo "## ğŸš€ ë¹Œë“œ ìš”ì•½ ë¦¬í¬íŠ¸"
                  echo "### ë² ì´ìŠ¤ ì´ë¯¸ì§€"
                  if [ "${{ needs.check-base-changes.outputs.base-changed }}" == "true" ]; then
                    echo "- ğŸ”„ ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì¬ë¹Œë“œë¨"
                    echo "- Hash: ${{ needs.check-base-changes.outputs.requirements-hash }}"
                  else
                    echo "- âœ… ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì¬ì‚¬ìš©ë¨ (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•!)"
                  fi

                  echo "### ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€"
                  echo "- ğŸ“¦ ìµœì¢… ì´ë¯¸ì§€: ${{ env.APP_IMAGE_NAME }}:${{ env.FINAL_IMAGE_TAG }}"
                  echo "- ğŸ¯ ì˜ˆìƒ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•: 60-80%"

                  echo "### ë‹¤ìŒ ë‹¨ê³„"
                  echo "- Harbor ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ì´ë¯¸ì§€ í™•ì¸"
                  echo "- K8s ë°°í¬ì‹œ ìƒˆë¡œìš´ íƒœê·¸ ì‚¬ìš©"
